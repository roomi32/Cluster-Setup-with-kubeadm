<!DOCTYPE html>
<html>
<head>
<title>1.Kubeadm.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<p>Information Source: OpenSourceEducation.net by Sir Babar Zahoor Sahab and kubernetes.io</p>
<p>Kubernetes, also known as k8s, is an open-source platform used for managing containerized applications. It automates container deployment, scaling, and management, making it easier for developers to build, deploy, and run their applications. Kubeadm and Calico are tools used to install and manage Kubernetes clusters.</p>
<p>In this guide, we will learn how to install Kubernetes using kubeadm and Calico.</p>
<h1 id="prerequisites">Prerequisites:</h1>
<p>Before we begin, ensure that you have the following prerequisites:</p>
<h3 id="hardware-requirements">Hardware requirements:</h3>
<p>You will need a minimum of two nodes to create a Kubernetes cluster. Each node should have at least 2GB of RAM and 2 CPU cores.</p>
<h3 id="software-requirements">Software requirements:</h3>
<p>Ensure that your nodes are running a Linux distribution that supports Kubernetes. Ubuntu 20.04 is recommended.</p>
<h3 id="network-requirements">Network requirements:</h3>
<p>The nodes should be able to communicate with each other over a network. Ensure that you have a reliable network connection between the nodes.</p>
<h3 id="ports-and-protocols">Ports and Protocols</h3>
<p>When running Kubernetes in an environment with strict network boundaries, such as on-premises datacenter with physical network firewalls or Virtual Networks in Public Cloud, it is useful to be aware of the ports and protocols used by Kubernetes components.</p>
<h2 id="control-plane">Control plane</h2>
<table>
<thead>
<tr>
<th style="text-align:center">Protocol</th>
<th style="text-align:center">Direction</th>
<th style="text-align:center">Port Range</th>
<th style="text-align:center">Purpose</th>
<th style="text-align:center">Used By</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">TCP</td>
<td style="text-align:center">Inbound</td>
<td style="text-align:center">6443</td>
<td style="text-align:center">Kubernetes API server</td>
<td style="text-align:center">ALL</td>
</tr>
<tr>
<td style="text-align:center">TCP</td>
<td style="text-align:center">Inbound</td>
<td style="text-align:center">2379-2380</td>
<td style="text-align:center">etcd server client API</td>
<td style="text-align:center">API 	kube-apiserver, etcd</td>
</tr>
<tr>
<td style="text-align:center">TCP</td>
<td style="text-align:center">Inbound</td>
<td style="text-align:center">10250</td>
<td style="text-align:center">Kubelet API</td>
<td style="text-align:center">Self, Control plane</td>
</tr>
<tr>
<td style="text-align:center">TCP</td>
<td style="text-align:center">Inbound</td>
<td style="text-align:center">10259</td>
<td style="text-align:center">kube-scheduler</td>
<td style="text-align:center">Self</td>
</tr>
<tr>
<td style="text-align:center">TCP</td>
<td style="text-align:center">Inbound</td>
<td style="text-align:center">10257</td>
<td style="text-align:center">kube-controller-manager</td>
<td style="text-align:center">Self</td>
</tr>
</tbody>
</table>
<hr>
<p>Although etcd ports are included in control plane section, you can also host your own etcd cluster externally or on custom ports.</p>
<h2 id="worker-nodes">Worker node(s)</h2>
<table>
<thead>
<tr>
<th style="text-align:center">Protocol</th>
<th style="text-align:center">Direction</th>
<th style="text-align:center">Port Range</th>
<th style="text-align:center">Purpose</th>
<th style="text-align:center">Used By</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">TCP</td>
<td style="text-align:center">Inbound</td>
<td style="text-align:center">10250</td>
<td style="text-align:center">Kubelet API</td>
<td style="text-align:center">Self, Control plane</td>
</tr>
<tr>
<td style="text-align:center">TCP</td>
<td style="text-align:center">Inbound</td>
<td style="text-align:center">30000-32767</td>
<td style="text-align:center">NodePort Services</td>
<td style="text-align:center">All</td>
</tr>
</tbody>
</table>
<hr>
<p>All default port numbers can be overridden. When custom ports are used those ports need to be open instead of defaults mentioned here.</p>
<h1 id="installation-of-kubeadm-and-calico-step-by-step">Installation of Kubeadm and Calico: Step By Step</h1>
<h2 id="step-1-setup-unuque-hostnames">Step 1: Setup Unuque Hostnames</h2>
<p>To ensure that nodes can communicate with each other using their hostnames, we need to modify the <strong>/etc/hosts</strong> file on all nodes by adding the necessary host enteries. You can do this by running the following command on each node:</p>
<pre class="hljs"><code><div>sudo vim /etc/hosts
</div></code></pre>
<p>This will open the file in the vim text editor. Add the following lines to the end of the file, replacing the IP addresses with those of your own nodes:</p>
<blockquote>
<p>10.0.0.2        master-node</p>
<p>10.0.0.3        worker-node</p>
</blockquote>
<p>Save and close the file.</p>
<h2 id="step-2-turn-off-swap-memory">Step 2: Turn off Swap Memory</h2>
<p>Kubernetes requires that swap memory be disabled on all nodes. You can turn off swap memory by running the following command on each nodes:</p>
<pre class="hljs"><code><div>sudo swapoff -a
</div></code></pre>
<pre class="hljs"><code><div>sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
</div></code></pre>
<h2 id="step-3-docker-installation">step 3: Docker Installation</h2>
<h3 id="installing-docker-from-the-default-repositories">Installing Docker from the Default Repositories</h3>
<p>In this way to install Docker on Ubuntu is to use the default Ubuntu repository. Although the installation process is more straightforward, the Docker package may be outdated. If you don't care about having the latest Docker version, follow the steps below and install Docker using the default repository.</p>
<h4 id="1-update-the-repository">1. Update the Repository</h4>
<p>Ensure that the local system package repository is updated by running:</p>
<pre class="hljs"><code><div>sudo apt update
</div></code></pre>
<p>Enter the root password when prompted and wait for the process to finish.</p>
<h4 id="2-install-docker">2. Install Docker</h4>
<p>Run the following command to install Docker:</p>
<pre class="hljs"><code><div>sudo apt install docker.io -y
</div></code></pre>
<p>Specifying the <strong>-y</strong> flag automatically answers <strong>yes</strong> to any prompt during the installation.</p>
<h4 id="3-install-dependencies">3. Install Dependencies</h4>
<p>Install all the Docker dependency packages by running the following command:</p>
<pre class="hljs"><code><div>sudo snap install docker
</div></code></pre>
<h4 id="4-check-installation">4. Check Installation</h4>
<p>Check whether Docker was properly installed by running the <strong>status</strong> command or checking the program version. To see the Docker daemon status, run:</p>
<pre class="hljs"><code><div>sudo systemctl status docker
</div></code></pre>
<h2 id="step-4-set-up-the-ipv4-bridge-on-all-nodes">Step 4: Set up the IPV4 bridge on all nodes</h2>
<p>To set up the IPV4 bridge on all nodes, Execute the below mentioned instructions at all nodes:</p>
<pre class="hljs"><code><div>cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

sudo modprobe overlay
sudo modprobe br_netfilter

# sysctl params required by setup, params persist across reboots
cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

# Apply sysctl params without reboot
sudo sysctl --system
</div></code></pre>
<p>These commands will set up the necessary network bridge and kernel parameters required by Kubernetes.</p>
<h2 id="step-5-update-the-repo-and-download-all-the-required-packages">Step 5: Update the repo and download all the required packages</h2>
<p>Now, you need to update the package repository and download all the necessary packages. Run the following commands on each node:</p>
<pre class="hljs"><code><div>sudo apt-get update
</div></code></pre>
<pre class="hljs"><code><div>sudo apt-get install -y apt-transport-https ca-certificates curl
</div></code></pre>
<h2 id="step-6-download-the-google-cloud-public-signing-key">Step 6: Download the Google Cloud public signing key</h2>
<p>To download the Google Cloud public signing key, run the following commands on each node:</p>
<pre class="hljs"><code><div>sudo mkdir -p /etc/apt/keyrings
</div></code></pre>
<pre class="hljs"><code><div>curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
</div></code></pre>
<h2 id="step-7-add-k8s-apt-repository">Step 7: Add K8s apt Repository</h2>
<p>To add the Kubernetes apt repository, run the followings command on each nodes:</p>
<pre class="hljs"><code><div>echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
</div></code></pre>
<h2 id="step-8-update-repo--install-kubelet-kubeadm-and-kubectl">Step 8: Update repo  &amp; install kubelet, kubeadm and kubectl</h2>
<p>Now you are ready to install Kubernetes and Docker on all nodes. Run the following commands on each node:</p>
<pre class="hljs"><code><div>sudo apt-get update
</div></code></pre>
<pre class="hljs"><code><div>sudo apt install -y kubelet=1.28.4 kubeadm=1.28.4 kubectl=1.28.4
</div></code></pre>
<pre class="hljs"><code><div>sudo apt-mark hold kubelet kubeadm kubectl docker.io
</div></code></pre>
<p>This will install the necessary Kubernetes packages and mark them as held so that they don’t get automatically upgraded.</p>
<h2 id="step-9-configure-containerd-on-all-nodes">Step 9: Configure containerd on all nodes</h2>
<p>In this step, you need to create a directory for containerd, a container runtime, and copy its default configuration file named <strong>“config.toml”</strong>. You can do this with the following commands:</p>
<pre class="hljs"><code><div>sudo mkdir /etc/containerd
</div></code></pre>
<pre class="hljs"><code><div>sudo sh -c &quot;containerd config default &gt; /etc/containerd/config.toml&quot;
</div></code></pre>
<p>After running these commands, you need to edit the config.toml file and find an entry that sets the value of “SystemdCgroup” to false. You need to change this value to true, save the file and then restart containerd with the following command:</p>
<pre class="hljs"><code><div>sudo sed -i 's/            SystemdCgroup = false/            SystemdCgroup = true/' /etc/containerd/config.toml
</div></code></pre>
<pre class="hljs"><code><div>sudo systemctl restart containerd.service
</div></code></pre>
<pre class="hljs"><code><div>sudo systemctl restart kubelet.service
</div></code></pre>
<pre class="hljs"><code><div>sudo systemctl enable kubelet.service
</div></code></pre>
<p>Note that these commands need to be run as a root on all nodes in your Kubernetes cluster.</p>
<h2 id="step-10-initialize-kubeadm">Step 10: Initialize Kubeadm</h2>
<p>On the <strong>Master Node</strong>, run these commands. This will initialize the Kubernetes <strong>control plane</strong>.</p>
<pre class="hljs"><code><div>sudo kubeadm config images pull
</div></code></pre>
<pre class="hljs"><code><div>sudo kubeadm init --pod-network-cidr=192.168.0.0/16
</div></code></pre>
<h2 id="step-11-copy-configuration-file-to-users-directory">Step 11: Copy Configuration File to User’s Directory</h2>
<p>On the <strong>Master Node</strong>, copy the configuration file to the user’s directory by running the following commands:</p>
<pre class="hljs"><code><div>mkdir -p $HOME/.kube
</div></code></pre>
<pre class="hljs"><code><div>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</div></code></pre>
<pre class="hljs"><code><div>sudo chown $(id -u):$(id -g) $HOME/.kube/config
</div></code></pre>
<p>This will allow the user to interact with the Kubernetes cluster.</p>
<h2 id="step-12-setup-calico-network">Step 12: Setup Calico Network</h2>
<p>After initializing kubeadm, you need to setup Calico network in order to enable pod-to-pod communication. Run the following commands on the master node:</p>
<pre class="hljs"><code><div>kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/tigera-operator.yaml
</div></code></pre>
<pre class="hljs"><code><div>curl https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/custom-resources.yaml -o
</div></code></pre>
<pre class="hljs"><code><div>sed -i 's/cidr: 192\.168\.0\.0\/16/cidr: 10.10.0.0\/16/g' custom-resources.yaml
</div></code></pre>
<pre class="hljs"><code><div>kubectl create -f custom-resources.yaml
</div></code></pre>
<h2 id="step-13-join-worker-nodes">Step 13: Join Worker Nodes</h2>
<p>Once the master node is set up, you can join worker nodes to the cluster. When you initialize kubeadm on the master node, you will receive a token that you can use to join worker nodes to the cluster. The token should look something like this:</p>
<pre class="hljs"><code><div>kubeadm join 10.0.0.2:6443 --token ndi3ae.ujwfcuais8zm2cyn --discovery-token-ca-cert-hash sha256:fc6c1094159833bf95a3fcb7d49960026e4ddad56f8648b94240cd1c867b2f6b
</div></code></pre>
<p>Copy the token and run it on all worker nodes to join them to the cluster.</p>
<h2 id="step-14-verify-the-cluster">Step 14: Verify the Cluster</h2>
<p>After all nodes have joined the cluster, you can verify that it is up and running by running the following commands on the master node:</p>
<pre class="hljs"><code><div>kubectl get no
</div></code></pre>
<pre class="hljs"><code><div>kubectl get po -A
</div></code></pre>
<p>This will display a list of all the nodes in the cluster and all the pods running in the cluster, respectively.</p>

</body>
</html>
